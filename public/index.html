<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Will you be my Valentine?</title>
  <style>
    :root{
      --bg1:#f6c4d7;
      --bg2:#f2a9c6;
      --card:#ffffffcc;
      --text:#1f1f1f;
      --muted:#6b6b6b;
      --yes:#ff3b86;
      --yes2:#ff5ea3;
      --no:#ffffff;
      --shadow: 0 20px 60px rgba(0,0,0,.18);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 30% 20%, #ffe4ef 0%, transparent 60%),
        radial-gradient(900px 700px at 70% 60%, #ffd1e2 0%, transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow:hidden;
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    .wrap{
      width:100%;
      max-width:1120px;
      margin:0 auto;
      padding:24px;
      display:grid;
      place-items:center;
    }
    .card{
      width:100%;
      max-width:980px;
      margin:0 auto;
      background:
        radial-gradient(1200px 520px at 30% 10%, rgba(255,255,255,.86) 0%, rgba(255,255,255,.58) 55%, rgba(255,255,255,.42) 100%),
        linear-gradient(135deg, rgba(255,255,255,.72), rgba(255,255,255,.46));
      backdrop-filter: blur(12px);
      border-radius:var(--radius);
      box-shadow: 0 28px 90px rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.68);
      overflow:hidden;
      padding:38px 36px 32px;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:1px;
      border-radius: calc(var(--radius) - 1px);
      border:1px solid rgba(255,255,255,.52);
      pointer-events:none;
      z-index:0;
    }
    .card::after{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height: 220px;
      background: radial-gradient(700px 240px at 50% 0%, rgba(255,255,255,.72), rgba(255,255,255,0) 70%);
      pointer-events:none;
      z-index:0;
      opacity:.65;
    }
    .card > *{ position:relative; z-index:1; }
    .top{
      display:grid;
      place-items:center;
      gap:14px;
      margin-bottom:12px;
    }
    .cat{
      width:84px;height:84px;
      border-radius:50%;
      background:#f3b072;
      position:relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
    }
    .cat:before, .cat:after{
      content:"";
      position:absolute;
      top:10px;
      width:0;height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-bottom:18px solid #e79d5f;
    }
    .cat:before{left:10px; transform: rotate(-14deg);}
    .cat:after{right:10px; transform: rotate(14deg);}
    .eye{
      position:absolute; top:34px; width:8px; height:8px; border-radius:50%;
      background:#202020;
    }
    .eye.left{left:26px;}
    .eye.right{right:26px;}
    .nose{
      position:absolute; top:48px; left:50%; transform:translateX(-50%);
      width:10px; height:8px; border-radius: 0 0 10px 10px;
      background:#ff6b8a;
    }
    .heart{
      position:absolute;
      right:-6px; top:-6px;
      width:26px; height:26px;
      transform: rotate(20deg);
      background: radial-gradient(circle at 30% 30%, #ff86b6, #ff2f7a);
      clip-path: path("M 13 24 C 3 17 0 12 0 8 C 0 3 4 0 8 0 C 10 0 12 1 13 3 C 14 1 16 0 18 0 C 22 0 26 3 26 8 C 26 12 23 17 13 24 Z");
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.15));
    }
    h1{
      margin:0;
      font-size: clamp(22px, 3.4vw, 34px);
      font-weight:800;
      letter-spacing:-.02em;
      text-align:center;
    }
    h1 .name{
      font-weight:900;
    }
    .sub{
      margin:6px 0 0;
      color:var(--muted);
      font-size:14px;
      text-align:center;
    }

    .arena{
      margin-top:18px;
      position:relative;
      height:205px;
      border-radius:16px;
      background: rgba(255,255,255,.45);
      border:1px solid rgba(255,255,255,.65);
      overflow:hidden;
    }

    .btn{
      position:absolute;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      border:none;
      cursor:pointer;
      font-weight:800;
      border-radius:999px;
      padding:16px 26px;
      font-size:18px;
      box-shadow: 0 14px 30px rgba(0,0,0,.14);
      transition: transform .12s ease, box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-width: 140px;
      touch-action: manipulation;
      z-index: 2;
    }
    .btn:active{transform: scale(.98)}
    .btn-yes{
      left: 24%;
      top: 56%;
      transform: translate(-50%, -50%);
      background: linear-gradient(180deg, var(--yes2), var(--yes));
      color:white;
      z-index: 3;
      touch-action: manipulation;
    }
    .btn-yes:hover{box-shadow: 0 18px 40px rgba(255,59,134,.35)}
    .btn-no{
      left: 76%;
      top: 56%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,.92);
      color:#222;
      border:1px solid rgba(0,0,0,.08);
    }
    .hint{
      position:absolute;
      bottom:12px;
      width:100%;
      text-align:center;
      font-size:13px;
      color:#5c5c5c;
      padding:0 12px;
      pointer-events: none;
    }

    /* Result modal */
    .overlay{
      position:fixed; inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      z-index:50;
      padding:12px;
    }
    .overlay.show{display:grid;}
    .modal{
      width:100%;
      max-width:1440px;
      margin:0 auto;
      background:
        radial-gradient(1200px 520px at 50% 0%, rgba(255,94,163,.16) 0%, rgba(255,255,255,.98) 44%, rgba(255,255,255,.92) 100%);
      border-radius: 26px;
      box-shadow: 0 48px 140px rgba(0,0,0,.34);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.70);
      position:relative;
    }
    .modal::before{
      content:"";
      position:absolute;
      inset:1px;
      border-radius: 25px;
      border:1px solid rgba(255,255,255,.52);
      pointer-events:none;
      z-index:0;
    }
    .modal::after{
      content:"";
      position:absolute;
      left:0; right:0; top:0;
      height: 240px;
      background: radial-gradient(760px 260px at 50% 0%, rgba(255,255,255,.78), rgba(255,255,255,0) 72%);
      pointer-events:none;
      z-index:0;
      opacity:.55;
    }
    .modal > *{ position:relative; z-index:1; }
    .modalTop{
      padding: 20px 30px 12px;
      text-align:center;
      width:100%;
      max-width:980px;
      margin:0 auto;
      position: relative;
      z-index: 5;
      background: transparent; /* keep it pure white from the modal itself */
    }
    .yay{
      margin:0;
      display:flex;
      align-items:baseline;
      justify-content:center;
      gap:10px;
      line-height:1;
    }

    .yayText{
      font-size: clamp(30px, 4.6vw, 54px);
      font-weight:950;
      letter-spacing:-.04em;
      text-transform:uppercase;
      color: var(--yes); /* fallback */
    }

    @supports (-webkit-background-clip: text) {
      .yayText{
        background: linear-gradient(180deg, var(--yes2), var(--yes));
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
      }
    }

    .yayEmoji{
      font-size: clamp(20px, 3.2vw, 34px);
      transform: translateY(2px);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      opacity:.95;
    }

    .modalSub{
      margin:10px auto 0;
      max-width: 900px;
      color: rgba(10,10,10,.74);
      font-size: clamp(16px, 2.0vw, 20px);
      line-height:1.28;
      letter-spacing:-.01em;
      font-weight:720;
    }

    .modalSub .subName{
      font-weight:950;
      color: rgba(10,10,10,.96);
    }

    .modalTop .yay,
    .modalTop .modalSub{
      transform: none;
    }
    .media{
      display:grid;
      grid-template-columns: 1fr;
      gap:0;
      background: #111;
      position: relative;
      overflow:hidden;
      margin-top: 0;
      height: clamp(460px, 70vh, 760px);
    }
    .media img,
    .media video{
      width:100%;
      height:100%;
      display:block;
      object-fit: cover;
    }

    /* GIF first, then fade video on top */
    .media{overflow:hidden;}
    .media #fireworksGif{
      position:absolute;
      inset:0;
      z-index:0;
      transition: opacity .9s ease;
    }
    .media #finaleVideo{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      z-index:1;
      opacity:0;
      transition: opacity .9s ease;
    }
    .media.showVideo #finaleVideo{opacity:1;}
    .media.showVideo #fireworksGif{opacity:0;}

    .media .overlay-img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      opacity: 0.28; /* more visible */
      pointer-events:none;
      user-select:none;
      mix-blend-mode: screen;
      filter: saturate(1.0) brightness(1.08) contrast(1.06);
    }
    .modalActions{
      padding:14px 18px 18px;
      display:flex;
      justify-content:center;
      gap:10px;
      width:100%;
      max-width:980px;
      margin:0 auto;
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(255,255,255,.70);
    }
    .btn-close{
      border:none;
      border-radius:999px;
      padding:12px 18px;
      font-weight:800;
      cursor:pointer;
      background: #1f1f1f;
      color:white;
    }
    .btn-close:hover{filter: brightness(1.05);}

    
    /* Sparkle burst (premium) */
    .sparkleLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:65; /* above confetti (60) */
      overflow:hidden;
    }

    .sparkle{
      position:fixed;
      left:0;
      top:0;
      width: var(--sz, 14px);
      height: var(--sz, 14px);
      transform: translate(-50%, -50%) scale(.35) rotate(0deg);
      opacity:0;
      mix-blend-mode: normal;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.14));
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,1) 0%, rgba(255,255,255,.92) 22%, rgba(255,255,255,0) 68%),
        linear-gradient(transparent 44%, rgba(255,255,255,.95) 50%, transparent 56%),
        linear-gradient(90deg, transparent 44%, rgba(255,255,255,.95) 50%, transparent 56%);
      border-radius: 10px;
      animation: sparkleBurst var(--dur, 1100ms) cubic-bezier(.15,.75,.25,1) forwards;
      will-change: transform, opacity;
    }

    @keyframes sparkleBurst{
      0%{ opacity:0; transform: translate(-50%, -50%) scale(.35) rotate(0deg); }
      12%{ opacity:1; }
      40%{ opacity:1; transform: translate(calc(-50% + (var(--dx, 0px) * .35)), calc(-50% + (var(--dy, 0px) * .35))) scale(1.05) rotate(var(--rot, 90deg)); }
      100%{ opacity:0; transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(.25) rotate(calc(var(--rot, 90deg) + 120deg)); }
    }

    .btn-love{
      border:none;
      border-radius:999px;
      padding:14px 26px;
      min-width:190px;
      font-weight:900;
      font-size:17px;
      letter-spacing:-.01em;
      cursor:pointer;
      color:white;
      position:relative;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      background:
        radial-gradient(120% 120% at 30% 20%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 55%),
        linear-gradient(180deg, var(--yes2), var(--yes));
      box-shadow:
        0 18px 42px rgba(255,59,134,.22),
        0 14px 30px rgba(0,0,0,.16);
      transition: transform .12s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn-love::after{
      content:"";
      position:absolute;
      inset:-2px -40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
      transform: translateX(-60%);
      opacity:0;
      transition: transform .6s ease, opacity .25s ease;
      pointer-events:none;
    }
    .btn-love:hover{
      box-shadow:
        0 22px 58px rgba(255,59,134,.28),
        0 18px 40px rgba(0,0,0,.18);
      filter: brightness(1.02);
    }
    .btn-love:hover::after{
      transform: translateX(60%);
      opacity:1;
    }
    .btn-love:active{transform: scale(.985)}
    .btn-love:focus-visible{
      outline:none;
      box-shadow:
        0 0 0 4px rgba(255,255,255,.65),
        0 0 0 8px rgba(255,59,134,.35),
        0 22px 58px rgba(255,59,134,.22);
    }

    /* Confetti canvas */
    canvas#confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:60;
      display:none;
    }
    canvas#confetti.show{display:block;}

    /* Mobile tuning */
    @media (max-width:520px){
      .arena{height:190px;}
      .btn{min-width: 132px; font-size:17px;}
      .btn-yes{left: 28%;}
      .btn-no{left: 72%;}
      .modal{border-radius: 22px;}
      .modalTop{padding: 16px 18px 10px;}
      .yayText{font-size: 34px;}
      .yayEmoji{font-size: 22px;}
      .modalSub{font-size: 16px; max-width: 92vw;}
      .media{height: clamp(280px, 45vh, 360px);}
      .modalActions{max-width: 92vw; padding: 12px 14px 16px;}
      .btn-love{min-width: 170px; padding: 13px 22px; font-size: 16px;}
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="sparkleLayer" id="sparkleLayer" aria-hidden="true"></div>

  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="cat" aria-hidden="true">
          <span class="heart"></span>
          <span class="eye left"></span>
          <span class="eye right"></span>
          <span class="nose"></span>
        </div>

        <div>
          <h1><span class="name" id="name">Ancu»õa,</span> will you be my valentine?</h1>
          <p class="sub">Try to say ‚ÄúNo‚Äù.</p>
        </div>
      </div>

      <div class="arena" id="arena">
        <button class="btn btn-yes" id="yesBtn">Yes</button>
        <button class="btn btn-no" id="noBtn" tabindex="-1" aria-label="No (good luck)"><span>No</span></button>
        <div class="hint" id="hint">‚ÄúNo‚Äù seems a bit shy.</div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay" role="dialog" aria-modal="true" aria-label="Valentine result">
    <div class="modal">
      <div class="modalTop">
        <p class="yay"><span class="yayText">YAY!</span> <span class="yayEmoji" aria-hidden="true">üéâ</span></p>
        <p class="modalSub" id="modalSub">Correct answer.</p>
      </div>

      <!-- Replace the images below with your preferred GIFs -->
      <div class="media" id="mediaBox">
        <!-- Fireworks/confetti GIF (shown first) -->
        <img id="fireworksGif" alt="Celebration" src="https://media.giphy.com/media/26tOZ42Mg6pbTUPHW/giphy.gif" />

        <!-- MP4 video (fades in on top) -->
        <video id="finaleVideo" playsinline webkit-playsinline preload="auto" crossorigin="anonymous">
          <source src="https://media.daviddango.com/coldplay.mp4" type="video/mp4" />
        </video>

        <!-- Soft overlay (local file in /public) -->
        <img class="overlay-img" src="da.jpeg" alt="" aria-hidden="true" />
      </div>

      <div class="modalActions">
        <button class="btn-love" id="loveBtn">One more</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Customize here ======
    const RECIPIENT_NAME = "Ancu»õa, "; // change this
    const YES_MESSAGE = "Ancu»õa, you just made my day.";
    // ============================

    const nameEl = document.getElementById("name");
    const arena = document.getElementById("arena");
    const noBtn = document.getElementById("noBtn");
    const yesBtn = document.getElementById("yesBtn");
    const overlay = document.getElementById("overlay");
    const loveBtn = document.getElementById("loveBtn");
    const sparkleLayer = document.getElementById("sparkleLayer");
    const modalSub = document.getElementById("modalSub");
    const mediaBox = document.getElementById("mediaBox");
    const finaleVideo = document.getElementById("finaleVideo");

    // ====== Beat-synced sparkles (Web Audio) ======
let audioCtx = null;
let analyser = null;
let freqData = null;
let beatRaf = null;
let beatStopTimer = null;
let lastBeatAt = 0;

async function ensureAnalyser() {
  if (!finaleVideo) return false;
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if (!Ctx) return false;

  try {
    if (!audioCtx) audioCtx = new Ctx();
    if (audioCtx.state === "suspended") await audioCtx.resume();

    if (!analyser) {
      const source = audioCtx.createMediaElementSource(finaleVideo);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = 0.85;

      source.connect(analyser);
      analyser.connect(audioCtx.destination);

      freqData = new Uint8Array(analyser.frequencyBinCount);
    }
    return true;
  } catch {
    return false;
  }
}

function stopBeatSparkles() {
  if (beatRaf) cancelAnimationFrame(beatRaf);
  beatRaf = null;
  if (beatStopTimer) clearTimeout(beatStopTimer);
  beatStopTimer = null;
}

function startBeatSparkles(durationMs = 2600) {
  if (!analyser || !freqData || !audioCtx) return;
  stopBeatSparkles();

  let ema = 0;
  let emaDev = 0;
  const cooldownMs = 170;
  const minThreshold = 0.014;

  const sr = audioCtx.sampleRate;
  const binHz = sr / analyser.fftSize;
  const startBin = Math.max(0, Math.floor(40 / binHz));
  const endBin = Math.min(freqData.length - 1, Math.floor(180 / binHz));

  function frame(t) {
    analyser.getByteFrequencyData(freqData);

    let sum = 0;
    for (let i = startBin; i <= endBin; i++) sum += freqData[i];
    const energy = sum / ((endBin - startBin + 1) * 255);

    const alpha = 0.08;
    ema = ema + alpha * (energy - ema);
    const diff = energy - ema;

    const beta = 0.10;
    emaDev = emaDev + beta * (Math.abs(diff) - emaDev);
    const threshold = Math.max(minThreshold, emaDev * 1.6);

    if (diff > threshold && (t - lastBeatAt) > cooldownMs) {
      lastBeatAt = t;
      burstSparkles(14);
    }

    beatRaf = requestAnimationFrame(frame);
  }

  beatRaf = requestAnimationFrame(frame);
  beatStopTimer = setTimeout(stopBeatSparkles, durationMs);
}

    function playFinaleVideo(){
      if (!finaleVideo) return;
      try {
        finaleVideo.pause();
        finaleVideo.currentTime = 0;
        finaleVideo.muted = false;
        finaleVideo.volume = 1;
        finaleVideo.load();
        const p = finaleVideo.play();
        if (p && typeof p.catch === "function") p.catch(() => {});
      } catch(_){ }
    }

    function stopFinaleVideo(){
      if (!finaleVideo) return;
      try {
        finaleVideo.pause();
        finaleVideo.currentTime = 0;
      } catch(_){ }
    }

    const VIDEO_FADE_DELAY_MS = 4200; // show GIF longer, then fade video in
    let videoRevealTimer = null;


    function scheduleVideoReveal(){
      if (!mediaBox) return;
      mediaBox.classList.remove("showVideo");
      if (videoRevealTimer) clearTimeout(videoRevealTimer);
      videoRevealTimer = setTimeout(() => {
        videoRevealTimer = null;
        mediaBox.classList.add("showVideo");
      }, VIDEO_FADE_DELAY_MS);
    }

    function resetVideoReveal(){
      if (!mediaBox) return;
      mediaBox.classList.remove("showVideo");
      if (videoRevealTimer) {
        clearTimeout(videoRevealTimer);
        videoRevealTimer = null;
      }
    }

    function clearSparkles(){
      if (!sparkleLayer) return;
      sparkleLayer.innerHTML = "";
    }

    function burstSparkles(count = 34){
      if (!sparkleLayer || !loveBtn) return;

      const rect = loveBtn.getBoundingClientRect();
      const cx = rect.left + rect.width / 2;
      const cy = rect.top + rect.height / 2;

      const mediaRect = mediaBox ? mediaBox.getBoundingClientRect() : null;

      // Premium palette: white + warm gold + soft pink
      const colors = [
        "rgba(255,255,255,1)",
        "rgba(255,240,210,1)",
        "rgba(255,210,230,1)",
        "rgba(255,255,255,.95)"
      ];

      const mainCount = count;
      const ambientCount = Math.round(count * 0.55);

      // 1) Main burst from the button (wider radius + bigger sparkles)
      for (let i = 0; i < mainCount; i++){
        const el = document.createElement("div");
        el.className = "sparkle";

        const ang = Math.random() * Math.PI * 2;
        const dist = 28 + Math.random() * 260; // wider spread
        const dx = Math.cos(ang) * dist;
        const dy = Math.sin(ang) * dist - (10 + Math.random() * 14);

        const sz = 14 + Math.random() * 22;      // bigger
        const dur = 1100 + Math.random() * 900;  // slightly longer
        const delay = Math.random() * 180;
        const rot = (-35 + Math.random() * 70) + "deg";
        const c = colors[(Math.random() * colors.length) | 0];

        el.style.left = cx + "px";
        el.style.top = cy + "px";
        el.style.setProperty("--dx", dx + "px");
        el.style.setProperty("--dy", dy + "px");
        el.style.setProperty("--sz", sz + "px");
        el.style.setProperty("--dur", dur + "ms");
        el.style.setProperty("--rot", rot);
        el.style.animationDelay = delay + "ms";

        el.style.background =
          `radial-gradient(circle at 50% 50%, ${c} 0%, rgba(255,255,255,.92) 22%, rgba(255,255,255,0) 68%),` +
          `linear-gradient(transparent 44%, rgba(255,255,255,.95) 50%, transparent 56%),` +
          `linear-gradient(90deg, transparent 44%, rgba(255,255,255,.95) 50%, transparent 56%)`;

        sparkleLayer.appendChild(el);
        el.addEventListener("animationend", () => el.remove());
      }

      // 2) Ambient sparkles over the video area (so it feels "on screen", not just near the button)
      for (let i = 0; i < ambientCount; i++){
        const el = document.createElement("div");
        el.className = "sparkle";

        const c = colors[(Math.random() * colors.length) | 0];
        const sz = 10 + Math.random() * 18;
        const dur = 900 + Math.random() * 850;
        const delay = 120 + Math.random() * 280;
        const rot = (-25 + Math.random() * 50) + "deg";

        const x = mediaRect ? (mediaRect.left + Math.random() * mediaRect.width) : (Math.random() * window.innerWidth);
        const y = mediaRect ? (mediaRect.top + Math.random() * mediaRect.height) : (Math.random() * window.innerHeight);

        // Small drift so it twinkles + moves a bit
        const dx = (-40 + Math.random() * 80);
        const dy = (-60 + Math.random() * 90);

        el.style.left = x + "px";
        el.style.top = y + "px";
        el.style.setProperty("--dx", dx + "px");
        el.style.setProperty("--dy", dy + "px");
        el.style.setProperty("--sz", sz + "px");
        el.style.setProperty("--dur", dur + "ms");
        el.style.setProperty("--rot", rot);
        el.style.animationDelay = delay + "ms";

        el.style.background =
          `radial-gradient(circle at 50% 50%, ${c} 0%, rgba(255,255,255,.92) 22%, rgba(255,255,255,0) 68%),` +
          `linear-gradient(transparent 44%, rgba(255,255,255,.95) 50%, transparent 56%),` +
          `linear-gradient(90deg, transparent 44%, rgba(255,255,255,.95) 50%, transparent 56%)`;

        sparkleLayer.appendChild(el);
        el.addEventListener("animationend", () => el.remove());
      }
    }

    nameEl.textContent = RECIPIENT_NAME;

    function setModalSub(text){
      if (!modalSub) return;
      modalSub.textContent = "";
      const idx = text.indexOf(",");
      if (idx !== -1){
        const namePart = text.slice(0, idx + 1);
        const rest = text.slice(idx + 1).trimStart();

        const span = document.createElement("span");
        span.className = "subName";
        span.textContent = namePart;

        modalSub.appendChild(span);
        if (rest) modalSub.appendChild(document.createTextNode(" " + rest));
      } else {
        modalSub.textContent = text;
      }
    }

    setModalSub(YES_MESSAGE);

    // Helper: clamp
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

    // Move "No" away from pointer when it gets close
    let noPos = { x: 0.76, y: 0.56 }; // relative positions inside arena (0..1)
    const dangerRadius = 160;         // px: more sensitive (reacts sooner)
    const step = 260;                 // px: jumps much farther

    function placeNo(relX, relY){
      const edgePaddingX = 0.18;
      const edgePaddingY = 0.26;

      // If too close to any edge, push it aggressively back toward center
      if (relX < edgePaddingX) relX = 0.5 + Math.random() * 0.25;
      if (relX > 1 - edgePaddingX) relX = 0.5 - Math.random() * 0.25;
      if (relY < edgePaddingY) relY = 0.5 + Math.random() * 0.20;
      if (relY > 1 - edgePaddingY) relY = 0.5 - Math.random() * 0.20;

      noPos.x = clamp(relX, 0.12, 0.88);
      noPos.y = clamp(relY, 0.22, 0.78);

      const rect = arena.getBoundingClientRect();
      noBtn.style.left = (noPos.x * rect.width) + "px";
      noBtn.style.top  = (noPos.y * rect.height) + "px";
      noBtn.style.transform = "translate(-50%, -50%)";
    }

    // Initial placement after layout
    requestAnimationFrame(() => placeNo(noPos.x, noPos.y));
    window.addEventListener("resize", () => placeNo(noPos.x, noPos.y));

    function fleeFrom(clientX, clientY){
      const rect = arena.getBoundingClientRect();
      const bx = noPos.x * rect.width;
      const by = noPos.y * rect.height;

      const px = clientX - rect.left;
      const py = clientY - rect.top;

      const dx = bx - px;
      const dy = by - py;
      const dist = Math.hypot(dx, dy);

      if (dist > dangerRadius) return;

      // Move away along vector, with a bit of randomness to avoid edges
      const ux = (dx / (dist || 1));
      const uy = (dy / (dist || 1));

      const nx = (bx + ux * step + (Math.random() - 0.5) * 60) / rect.width;
      const ny = (by + uy * step + (Math.random() - 0.5) * 40) / rect.height;

      placeNo(nx, ny);
    }

    // Mouse / pointer tracking
    arena.addEventListener("pointermove", (e) => {
      fleeFrom(e.clientX, e.clientY);
    });

    // Also flee on hover / attempt to focus (desktop)
    noBtn.addEventListener("pointerenter", (e) => {
      fleeFrom(e.clientX, e.clientY);
    });

    // Touch devices: if user taps near, it flees
    arena.addEventListener("pointerdown", (e) => {
      if (e.target === yesBtn) return;
      fleeFrom(e.clientX, e.clientY);
    });

    function activateYes(e){
      if (overlay.classList.contains("show")) return;

      // Allow only primary button for mouse; touch/pen are fine
      if (e && e.type === "pointerdown" && e.pointerType === "mouse" && e.button !== 0) return;

      if (e){
        // Prevent scroll/drag so the press doesn't get interpreted as movement
        if (e.cancelable) e.preventDefault();
        e.stopPropagation();
        // Keep the pointer with the button even if the overlay appears
        try { if (e.pointerId != null) yesBtn.setPointerCapture(e.pointerId); } catch(_){ }
      }

      openResult();
    }

    // Fire on pointerdown for maximum reliability on mobile
    yesBtn.addEventListener("pointerdown", activateYes);

    // Keyboard / accessibility fallback
    yesBtn.addEventListener("click", (e) => {
      if (e && e.cancelable) e.preventDefault();
      activateYes(e);
    });

    let canCloseOverlay = true;

    function openResult(){
      if (overlay.classList.contains("show")) return;
      // Prevent the opening gesture from also triggering an immediate close
      canCloseOverlay = false;

      overlay.classList.add("show");
      startConfetti();
      playFinaleVideo();
      scheduleVideoReveal();
      // Start beat-synced sparkles automatically with the music
      ensureAnalyser().then((ok) => {
        if (ok) startBeatSparkles(6200); // sync for first ~6.2s
      });

      // Arm closing after the current gesture/event loop finishes
      requestAnimationFrame(() => {
        setTimeout(() => { canCloseOverlay = true; }, 60);
      });
    }

    function closeModal(){
      overlay.classList.remove("show");
      stopConfetti();
      stopFinaleVideo();
      resetVideoReveal();
      clearSparkles();
      stopBeatSparkles();
    }

loveBtn.addEventListener("click", () => {
  // Pure visual replay (longer, cascading sparkles)
  burstSparkles(26);
  setTimeout(() => burstSparkles(20), 220);
  setTimeout(() => burstSparkles(18), 520);
  setTimeout(() => burstSparkles(16), 820);
  setTimeout(() => burstSparkles(14), 1120);
  setTimeout(() => burstSparkles(12), 1420);
});
    overlay.addEventListener("click", (e) => {
      if (!canCloseOverlay) return;
      if (e.target === overlay) closeModal();
    });
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.classList.contains("show")) closeModal();
    });

    // ====== Minimal confetti (no libraries) ======
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");

    let confettiOn = false;
    let confettiMode = "off"; // "burst" | "drizzle" | "off"
    let particles = [];
    let rafId = null;
    let burstInterval = null;
    let stopTimeout = null;

    const CONFETTI_COLORS = [
      "#ff3b86",
      "#ff5ea3",
      "#ffd1e2",
      "#ffffff",
      "#ffcc00",
      "#00d4ff",
      "#7cff6b"
    ];

    function resizeCanvas(){
      canvas.width = window.innerWidth * devicePixelRatio;
      canvas.height = window.innerHeight * devicePixelRatio;
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function makeParticle(w, h, mode = confettiMode){
      const drizzle = mode === "drizzle";
      return {
        x: Math.random() * w,
        // Spawn above the viewport so it "rains" from the top
        y: -60 - Math.random() * h * 0.25,
        r: 2 + Math.random() * 4,
        // Drizzle is calmer; burst is more energetic
        vy: (drizzle ? (2 + Math.random() * 4) : (3 + Math.random() * 8)),
        vx: (drizzle ? (-1.2 + Math.random() * 2.4) : (-2.2 + Math.random() * 4.4)),
        a: Math.random() * Math.PI * 2,
        va: (drizzle ? (-0.18 + Math.random() * 0.36) : (-0.25 + Math.random() * 0.5)),
        c: CONFETTI_COLORS[(Math.random() * CONFETTI_COLORS.length) | 0],
      };
    }

    function makeParticles(count){
      const w = window.innerWidth;
      const h = window.innerHeight;
      particles = Array.from({length: count}, () => makeParticle(w, h, confettiMode));
    }

    function addParticles(count){
      const w = window.innerWidth;
      const h = window.innerHeight;
      for (let i = 0; i < count; i++) particles.push(makeParticle(w, h, confettiMode));

      // Keep a hard cap to avoid runaway CPU/GPU usage
      const MAX = 900;
      if (particles.length > MAX) particles.splice(0, particles.length - MAX);
    }
    function startDrizzle(){
      confettiOn = true;
      confettiMode = "drizzle";
      canvas.classList.add("show");

      // Stop burst waves
      if (burstInterval) {
        clearInterval(burstInterval);
        burstInterval = null;
      }

      // Keep only a small, steady amount that recycles
      makeParticles(70);

      cancelAnimationFrame(rafId);
      draw();
    }

    function draw(){
      if (!confettiOn) return;
      const w = window.innerWidth;
      const h = window.innerHeight;
      ctx.clearRect(0, 0, w, h);

      for (const p of particles){
        p.x += p.vx;
        p.y += p.vy;
        p.a += p.va;

        if (p.y > h + 40){
          p.y = -20;
          p.x = Math.random() * w;
        }

        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = p.c;
        ctx.fillRect(-p.r, -p.r, p.r * 2.2, p.r * 1.6);
        ctx.restore();
      }

      rafId = requestAnimationFrame(draw);
    }

    function startConfetti(ms = 17000){
      confettiOn = true;
      confettiMode = "burst";
      canvas.classList.add("show");

      // Big initial wave (moderate)
      makeParticles(450);

      // Then add waves (one after another) while in burst mode
      if (burstInterval) clearInterval(burstInterval);
      burstInterval = setInterval(() => {
        if (!confettiOn || confettiMode !== "burst") return;
        addParticles(140);
      }, 700);

      // Stop after the burst duration (no second drizzle set)
      if (stopTimeout) clearTimeout(stopTimeout);
      stopTimeout = setTimeout(() => {
        stopTimeout = null;
        if (confettiOn) stopConfetti();
      }, ms);

      cancelAnimationFrame(rafId);
      draw();
    }

    function stopConfetti(){
      confettiOn = false;
      confettiMode = "off";
      canvas.classList.remove("show");

      if (burstInterval) {
        clearInterval(burstInterval);
        burstInterval = null;
      }

      if (stopTimeout) {
        clearTimeout(stopTimeout);
        stopTimeout = null;
      }

      cancelAnimationFrame(rafId);
      ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
    }
  </script>
</body>
</html>